<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>NextBike on Mapy.cz</title>
        <script type="text/javascript" src="https://api.mapy.cz/loader.js"></script>
        <script type="text/javascript">Loader.load();</script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <style>
            html 
            {
                margin: 0px;
                height: 100%;
            }
            #m
            {
                height: 100vh;
                width: 100vw;
                position:absolute;
                top:0px;
                right:0px;
                bottom:0px;
                left:0px;
            }
        </style>
    <script>
        function onLoad()
        {
            var obrazek_empty = "kolo_empty_icon.png";
            var obrazek_full = "kolo_full_icon.png"

            var m = new SMap(JAK.gel("m"));
            m.addControl(new SMap.Control.Sync()); /* Aby mapa reagovala na změnu velikosti průhledu */
            m.addDefaultLayer(SMap.DEF_TURIST).enable(); /* Turistický podklad */
            var mouse = new SMap.Control.Mouse(SMap.MOUSE_PAN | SMap.MOUSE_WHEEL | SMap.MOUSE_ZOOM); /* Ovládání myší */
            m.addControl(mouse); 

            $.get( "https://api.nextbike.net/maps/nextbike-live.json?apikey=&city=661&include_domains=tg%2Cde&response_type=json&show_errors=1", function( returned_data )
            {
                var datatest = returned_data;
                var obj = datatest.countries[0].cities[0].places;
                var data = {};

                for (var key in obj)
                {
                    var value = obj[key];
                    data[value.name] = [value.lat, value.lng, value.bikes, value.name];
                }

                var znacky = [];
                var souradnice = [];

                for (var name in data) 
                { /* Vyrobit značky */
                    console.log(data[name]);
                    var c = SMap.Coords.fromWGS84(data[name][1], data[name][0]); /* Souřadnice značky, z textového formátu souřadnic */

                    var options = {
                        url: data[name][2] == 0 ? obrazek_empty : obrazek_full,
                        title: name,
                        anchor: { left: 0, bottom: 10 }  /* Ukotvení značky za bod uprostřed dole */
                    }
                    
                    var card = new SMap.Card();
                    card.getHeader().innerHTML = "<strong>" + data[name][3] + "</strong>";
                    card.getBody().innerHTML = "Počet kol: " + data[name][2] + "</em>";

                    var znacka = new SMap.Marker(c, null, options);
                    znacka.decorate(SMap.Marker.Feature.Card, card);
                    souradnice.push(c);
                    znacky.push(znacka);
                }
                
                /* Křivoklát ukotvíme za střed značky, přestože neznáme její velikost */
                var options = {
                    anchor: {left:0.5, top:0.5}
                }
                znacky[1].decorate(SMap.Marker.Feature.RelativeAnchor, options);

                var vrstva = new SMap.Layer.Marker();     /* Vrstva se značkami */
                m.addLayer(vrstva);                       /* Přidat ji do mapy */
                vrstva.enable();                         /* A povolit */
                
                for (var i=0; i < znacky.length; i++) {
                    vrstva.addMarker(znacky[i]);
                }

                var cz = m.computeCenterZoom(souradnice); /* Spočítat pozici mapy tak, aby značky byly vidět */
                m.setCenterZoom(cz[0], cz[1]);   
            });
        }
    </script>

    </head>
    <body id="advanced-markers" onload="onLoad();">
        <div id="m"></div>
    </body>
</html> 